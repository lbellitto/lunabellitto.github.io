<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Replicating the Paper: ‘Religious Protection from Populist Violence’</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="Writeup_files/libs/clipboard/clipboard.min.js"></script>
<script src="Writeup_files/libs/quarto-html/quarto.js"></script>
<script src="Writeup_files/libs/quarto-html/popper.min.js"></script>
<script src="Writeup_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Writeup_files/libs/quarto-html/anchor.min.js"></script>
<link href="Writeup_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Writeup_files/libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Writeup_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Writeup_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Writeup_files/libs/bootstrap/bootstrap-8a79a254b8e706d3c925cde0a310d4f0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
</head><body class="fullcontent">\usepackage[top=0.5in, bottom=1in, left=1in, right=1in]{geometry}
\usepackage{times}
\usepackage{setspace}
\doublespacing
\setlength{\parindent}{2em}
\usepackage{indentfirst}






<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Replicating the Paper: ‘Religious Protection from Populist Violence’</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div style="page-break-after: always;"></div>
<section id="introduction" class="level1">
<h1>1. Introduction</h1>
<p>The scope of this paper is to replicate and expand the statistical analysis presented in ‘Religious Protection from Populist Violence’ by Brooke et al.&nbsp;(2023). In particular, it focuses on replicating Model 4 from the original study and conducting additional analyses to explore potential improvements to the model.</p>
<p>Model 4 of the original paper predicts the number of killings occurred in the Philippines during the war on drugs. The model employs religious, economical, social, and political features gathered from different sources.</p>
<p>The first part of this project is dedicated to the replication of the original model, followed by efforts to develop new models aimed at improving predictive accuracy. In the analysis, a few models will be evaluated, and the best performing one will be selected to to generate scenario analyses focusing on a key independent variable of interest.</p>
<section id="original-analysis" class="level2">
<h2 class="anchored" data-anchor-id="original-analysis">1.1 Original Analysis</h2>
<p>The original study aims to understand the impact of international institutions in protecting from populist violence. In particular, the authors focus on religious institutions, believing that the latter are able to raise awareness on violence, provide protections for the citizens, and mobilize against the institutionalised use of force. The example analyzed in the original study focuses on the role of the Roman Catholic Church in reducing violence in the Philippines during the war on drugs. For this purpose, Brooke et al.&nbsp;(2023) develop models to predict the number of drug-related killings per neighborhood (barangay) in the National Capital Region (NCR). Using causal inference techniques, the study assesses whether the presence of Catholic parishes is associated with a decrease in killings.</p>
<p>The data-set includes data from the census, electoral returns, and transgovernmental organizations. The dependent variable accounts for the number of killings in each barangay, making it count data. Given that the analysis is conducted at the barangay level, the proximity of the different areas of interest raise concerns regarding the observational independence of the predictors. The large number of zeros in the data-set (Figure 1) suggests the presence of overdispersion, which makes a negative binomial the regression model of choice for the original study, and the population variable the exposure factor. For what concerns missing data, the authors dropped them leaving a data-set of 1,696 observations.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Writeup_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Figure 1. Representation of the Killing Count distribution. From the plot, it is possible to see the presence of overdispersion.</p>
</section>
</section>
<section id="predictive-models" class="level1">
<h1>2 Predictive Models</h1>
<section id="replication-model" class="level2">
<h2 class="anchored" data-anchor-id="replication-model">2.1 Replication Model</h2>
<p>In the original study, the authors analyse different models to predict the number of killings per barangay, consistently using a negative binomial regression for the inference due to overdispersion in the data; they also pick the logarithm of population as exposure term, accounting for different population sizes. Following this reasoning, the study includes four models that differ from each other for the selection of independent variables. The full model, which is the one replicated in this project, accounts for the presence of Catholic Churches in the barangay, the demographic of the victims, the political sentiment, the presence of police stations, and the presence of Methodist Churches.</p>
<p>More precisely, the demographic variables account for the percentage of the population with high school diplomas and the percentage of the presence of men between 15-24 years old since these two factors are assumed by the authors to belong to the population most at risk for “petty criminality” (Brooke et al., 2023). The political sentiment, instead, mainly refers to the support for Rodrigo Duerte, who strongly implemented the war on drugs in the Philippines. The presence of Methodist Churches performs a placebo test to verify that Catholic Churches themselves are reducing the number of victims thanks to their structure. Consequently, a lack of the difference between the two might signify a not valid assumption.</p>
<p>The following is the replication of the full model from the original study (table 1). Because of the use of different programs (Stata for the original study and R for the replication) and optimizers, the replicated model’s estimates slightly vary from those in the original analysis. Table 1 shows the successful replication of the full model from the original paper. Even if the estimates are slightly different because of the use of different programming languages, the regression confirms the results found in the study: the presence of a Catholic parish in a specific barangay is correlated to a lower killing count for that area.</p>
</section>
<section id="additional-models" class="level2">
<h2 class="anchored" data-anchor-id="additional-models">2.2 Additional Models</h2>
<p>During the analysis of the original paper, different predictors were analysed. The focus was mainly on political, economic, religious, and social factors. The following two models will test the interaction of economic variables and their influence on the predictions of killing counts.</p>
<section id="political-and-economic-model" class="level3">
<h3 class="anchored" data-anchor-id="political-and-economic-model">2.3 Political and Economic Model</h3>
<p>The first alternative model mantains the same factors of the full model from the original study. More precisely, it consists in a negative binomial taking into account the presence of Catholic Parishes in the Barangay, the the demographic and political predictors, the logarithm of the population as exposure term, and the placebo test. However, it modifies the demographic variables. The original study assumes that the lack of a high school diploma is associated with violence related to the war on drugs. The aim of this model (and the following one) will be to further analyse this dynamic: is economic unstability a good predictor for killing counts? For this purpose, the model removes the percentage of population with a high school diploma and include an interaction term which takes into account the percentage of residents of each barangay that are unemployed or outside the legal market who also do not have a diploma. For this aim, a new variable (Level of Education) taking into account the percentage of people without a diploma was created and then multiplied by the amount of people not registered in the legal market. This tests whether economic marginalization is a significant predictor of killing counts. This interaction allows for assessing whether low-educated, unemployed residents are particularly affected by drug-related killings (Table 2).</p>
</section>
<section id="economic-model" class="level3">
<h3 class="anchored" data-anchor-id="economic-model">2.4 Economic Model</h3>
<p>The second model further builds on the economic analysis introduced in the previous model. Indeed, it mantains the negative binomial structure and takes into account the same variables as the Political and Economical Model, but it removes the political predictors. More precisely, the model is still considering the presence of Catholic Parishes, the demographic features, population as the exposure term and the placebo test, which are meaningful for the analysis. However, the political variables, such as the political sentiment and the share vote for Duerte, are removed. The new model is focusing on the interaction between low education and unemployment in the legal market with the aim to understand if this specific category of citizens is highly related to the killing counts; in other words, if a resident with these specific demographics is more likely to be killed during the war on drugs. Consequently, the interaction term between the percentage of people without a diploma and a legal employment is used as predictor, but the influence of the political sentiment is removed, stressing the focus on economic factors (Table 2).</p>
<p>Table 2 shows the estimates for the different models. The “Replicated Model” is the same as the original study. The “Economic and Political Model” substitute the percentage of people with a diploma with the percentage of population without one that are also out of the legal employment market. The “Economic Model” removes the political variables from the previous model.</p>
</section>
</section>
</section>
<section id="model-evaluation" class="level1">
<h1>3 Model Evaluation</h1>
<p>All models in this analysis are negative binomial regressions, but each employes variables to focus on different social aspects. The first model is a replication of the original study and mainly focuses on political, religious, demographic and economic predictors. The “Political and Economic Model” changes the demographic variables by substituting the percentage of population with a diploma with the population that does not have a higher degree and is not legally employed. The “Economic Model” highlights economic factors rather than political ones. Consequently, a successful prediction of killings from the latter model signify economic conditions have an independent effect on the war on drugs even if not accounting for political factors. The significance of this predictor confirms this assumption. In order to compare the performance of the model, in-sample and out-of-sample evaluation is performed.</p>
<section id="in-sample-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="in-sample-evaluation">3.1 In Sample Evaluation</h2>
<p>The first evaluation performed is the in-sample analysis, focusing on the AIC, BIC results as well as the deviance of the estimations. As it is possible to conclude from table 2, all models present similar standard errors, with only minor differences, meaning none of the model is significanlty predicting more precise estimates than the others. The deviance values further confirm this observation, as they remain marginally lower for the Economic Model, indicating slightly improved estimation accuracy; however, the differences among the models is barely present. Similarly results concern the AIC and BIC. Both of the values are lower for the “Economic Model” suggesting that it more accurately estimates values, based on in-sample evaluation. Between the two other models, the Political and Economic Model outperforms the Replication Model based on AIC, but the BIC results suggest the opposite. Overall, the three models perform nearly equivalently in terms of in-sample evaluation. Figure 2 helps in the visualization of the in-sample model performances. In the visualization, the diagonal line represents perfect predictions of killing counts while the dots represent real values plotted against predicted ones for each model. The models have margin for improvement, but they all perform quite the same; in other words, there is not model that consistently place more points along the diagonal line. Since no model clearly outperforms the others, selecting the simplest one is the best option as it would require fewer predictions, reducing complexity and minimizing the risk of overfitting. However, out-of-sample evaluation is required to determine if a model is better performing on test data, allowing for better generalization.</p>
<p><img src="Writeup_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
<p>Figure 2. The diagonal represents ideal perfect predictions while the different dots are the real values plotted against the predicted ones. The figure allows to understand how each prediction of the model is far from the real value.</p>
</section>
<section id="out-of-sample-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="out-of-sample-evaluation">3.2 Out-of-Sample Evaluation</h2>
<p>Model evaluation involves comparing the performance of each model on testing data. For this purpose, a 10-fold cross-validation is used to evaluate the models on an out-of-sample basis. The performance is evaluated by comparing the Mean Squared Error and the R-squared, presented in Table 3.</p>
<table class="caption-top table">
<caption>Cross-Validation Results</caption>
<colgroup>
<col style="width: 34%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 13%">
<col style="width: 27%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Model</th>
<th style="text-align: right;">MSE</th>
<th style="text-align: right;">RMSE</th>
<th style="text-align: right;">MAE</th>
<th style="text-align: right;">R_squared</th>
<th style="text-align: right;">Pearson_Correlation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Replication Model</td>
<td style="text-align: right;">8.998</td>
<td style="text-align: right;">2.929</td>
<td style="text-align: right;">1.312</td>
<td style="text-align: right;">0.538</td>
<td style="text-align: right;">0.719</td>
</tr>
<tr class="even">
<td style="text-align: left;">Political Economic Model</td>
<td style="text-align: right;">8.778</td>
<td style="text-align: right;">2.885</td>
<td style="text-align: right;">1.302</td>
<td style="text-align: right;">0.531</td>
<td style="text-align: right;">0.713</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Economic Model</td>
<td style="text-align: right;">8.541</td>
<td style="text-align: right;">2.848</td>
<td style="text-align: right;">1.292</td>
<td style="text-align: right;">0.534</td>
<td style="text-align: right;">0.716</td>
</tr>
</tbody>
</table>
<p>Table 3. Out-of-sample results from a 10-fold cross-validation evaluating the three models under analysis. The Economic Model shows slightly lower residuals (MSE, RMSE), indicating better predictive accuracy. However, the Replication Model demonstrates the highest R squared, suggesting it better explains the most variance in the data.</p>
<p>Table 3 displays the results of the out-of-sample evaluation. The differences in residuals across models are minimal. By checking the Mean Squared Error, the Replication Model exhibits the largest residual, followed by the Political Economic Model, and the Economic Model having the lowest. Thus, the latter achieves the smallest residuals, suggesting slightly better predictive accuracy. However, these differences are so minor that they are not significant in determining the best-performing model (Figure 3).</p>
<p><img src="Writeup_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
<p>Figure 3. Representation of the Mean Squared Error for each model based on 10-fold cross-validation. While the Economic Model has the lowest MSE, the differences are minimal and negligible.</p>
<p>Another key parameter for assessing model performance is the R squared. Having the role of indicating the proportion of variance in the dependent variable explained by the model, the highest R squared suggests better explanatory power. As shown in Table 3, the Replication Model is the most successful in this aim, followed by the Economic Model, and the Political and Economic Model in the end. However, the differences among the three models are minimal, meaning R-squared alone cannot be sufficient to determine the best performing model. Figure 4 provides a visual comparison of this parameter.</p>
<p><img src="Writeup_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
<p>Figure 4. Visualization of R-squared from a 10-fold cross-validation. The Replication Model performs best, having the largest R-square, but the differences among the models remain minimal.</p>
</section>
<section id="selection-of-best-model" class="level2">
<h2 class="anchored" data-anchor-id="selection-of-best-model">3.3 Selection of Best Model</h2>
<p>The process of selecting the best model requires model comparison. Based on the in-sample evaluation, the Economic Model performs best by exhibiting the lowest deviance, AIc and BIC. The Economic and Political is the second best performing by checking the deviance and AIC parameter while the Replication Model is the second best performing based on the BIC. Neverthless, the differences betwween these parameters are minimal, meaning that they are not reliable indicators for selecting the best model. Moreover, a well-performing model should also accurately predict unseen data, making out-of-sample evaluation essential. In this study, 10-fold cross-validation is employed to assess model performance. The Economic Model is the best performing becuase it produces the lowest residuals and explains more variance than the other models. Even in this case, however, the differences between these parameters remain small, limiting their usefulness as decisive criteria. Since no model clearly outperforms the others, another factors to consider is the model simplicity. Indeed, a simpler model is preferable as it reduces the risk of overfitting and noise injection. In this instance, the Economic Model is the best selection over the Political and Economic Model as the first is a neasted model, meaning it is a subset of the other. Although it includes an interaction term, it contains fewer variables than the Replication Model. As a result, the smaller number of predictors combined with the slightly superior in-sample and out-of-sample performance makes the Economic Model the best choice.</p>
</section>
</section>
<section id="does-the-presence-of-catholic-parishes-affect-the-killings-count" class="level1">
<h1>4. Does the Presence of Catholic Parishes Affect the Killings Count?</h1>
<p>The original analysis aimed to examine the influence of Catholic parishes on killing counts. This study follows the same objective while emphasizing the economic well-being and level of education of individuals. Thus, it investigates how the presence of Catholic parishes impacts killing counts within a given area. For this aim, the following analysis specifically examines the independent variable representing the presence of Catholic parishes and its influence on the dependent variable, killing count. As a first step, two scenarios are created, keeping all other variables constant while varying the presence or absence of Catholic parishes. In these scenarios, the mean is used for all other continuous predictors, while the median is applied to categorical variables, ensuring a balanced representation of the data. The only variable that changes between the two scenarios is the presence of Catholic parishes.</p>
<p><img src="Writeup_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
<p>Figure 5. Representation of killings count in the absence (left) and presence (right) of Catholic Parishes, including the uncertainty interval.</p>
<p>Figure 5 illustrates this analysis, with the x-axis representing the presence or absence of Catholic parishes and the y-axis showing the killing count. The results indicate that, on average, the presence of Catholic parishes is associated with fewer killings (around 1.1), while their absence corresponds to an increase in the number of victims (approximately 1.5). Even when accounting for the uncertainty interval, the overall conclusion is the same. Consequently, the graph confirms the assumption that the presence of Catholic Parishes is linked to a lower number of killings, holding all the other varaibles constant.</p>
</section>
<section id="conclusion" class="level1">
<h1>5. Conclusion</h1>
<p>The replication and extension of Brooke et al.&nbsp;(2023) confirm that the presence of Catholic parishes is associated with lower killing counts during the Philippine war on drugs, consistent with the original study’s findings. Among the models analysed, the Economic Model slightly performs better both in-sample and out-of sample, meaning that the economic and education level are key factors in the violence related to war on drugs. It is also important to notitce the performance difference among the models is minimal, so no model significanlty outperforms others, making the simplest model the best choice. The original study assumed a relation between Catholic Parishes and a lower number of killings, reltion analysed also in this paper. However, the mainly observational nature of the study does not allow to confirm causation between the two. For this reason, further studies might be needed, by, for instance, assessing the division of barangay and implementing further models. In the end, this study and the original paper provide valuable insights, but further analysis are needed to confirm causality between Catholic Parishes and killing count.</p>
<div style="page-break-after: always;"></div>
</section>
<section id="references" class="level1">
<h1>References</h1>
<p>BROOKE ET AL. (2023), “Religious Protection from Populist Violence”,</p>
<p>https://www.jstor.org/stable/10.2307/48737499.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>